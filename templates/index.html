<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>局域网文件传输</title>
  <style>
    :root {
      --bg1: #f3f8ff;
      --bg2: #edf8f1;
      --panel: #ffffff;
      --line: #d7e0ea;
      --txt: #1d2b36;
      --muted: #607080;
      --mobile: #e8f7ff;
      --desktop: #eef8ea;
      --accent: #166534;
      --danger: #be123c;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: "Segoe UI", "PingFang SC", "Microsoft YaHei", sans-serif;
      color: var(--txt);
      background: radial-gradient(circle at 0% 0%, var(--bg1), transparent 55%),
                  radial-gradient(circle at 100% 100%, var(--bg2), transparent 50%),
                  #f7fafc;
      display: flex;
      justify-content: center;
      padding: 16px;
    }

    .app {
      width: min(720px, 100%);
      height: calc(100vh - 32px);
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 18px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      box-shadow: 0 12px 30px rgba(20, 35, 50, 0.08);
    }

    .top {
      padding: 12px 14px;
      border-bottom: 1px solid var(--line);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      background: #fbfdff;
    }

    .title {
      font-weight: 600;
      font-size: 15px;
    }

    .meta {
      color: var(--muted);
      font-size: 12px;
    }

    .status {
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
    }

    .status.ok { color: #0f766e; }
    .status.err { color: var(--danger); }

    .qr-card {
      margin: 12px 14px 0;
      border: 1px solid var(--line);
      border-radius: 12px;
      background: #f8fbff;
      padding: 12px;
      display: none;
      align-items: center;
      gap: 12px;
    }

    .qr-card.show { display: flex; }

    .qr-img {
      width: 96px;
      height: 96px;
      border: 1px solid #c8d6e5;
      border-radius: 8px;
      background: #fff;
      object-fit: contain;
      padding: 4px;
    }

    .qr-text {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .qr-meta {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .qr-title {
      font-size: 13px;
      font-weight: 600;
      color: #22384a;
    }

    .qr-link {
      font-size: 12px;
      color: #1d4ed8;
      text-decoration: none;
      word-break: break-all;
    }

    .qr-link:hover { text-decoration: underline; }

    .qr-expire {
      font-size: 12px;
      color: #465a6f;
    }

    .btn.qr-refresh {
      padding: 4px 8px;
      font-size: 12px;
    }

    .records {
      flex: 1;
      overflow-y: auto;
      padding: 14px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .empty {
      margin: auto;
      color: var(--muted);
      font-size: 13px;
    }

    .row {
      display: flex;
    }

    .row.mobile { justify-content: flex-end; }
    .row.desktop { justify-content: flex-start; }

    .bubble {
      max-width: 90%;
      border-radius: 12px;
      padding: 10px 12px;
      border: 1px solid var(--line);
      background: var(--mobile);
    }

    .row.desktop .bubble { background: var(--desktop); }

    .name {
      font-size: 14px;
      font-weight: 600;
      word-break: break-all;
    }

    .desc {
      margin-top: 4px;
      color: var(--muted);
      font-size: 12px;
    }

    .actions {
      margin-top: 8px;
      display: flex;
      gap: 8px;
    }

    .btn {
      border: 1px solid #b9c5d2;
      background: #fff;
      color: #243646;
      border-radius: 8px;
      font-size: 12px;
      padding: 6px 10px;
      cursor: pointer;
    }

    .btn.primary {
      border-color: #1d4ed8;
      color: #fff;
      background: #1d4ed8;
    }

    .btn.send {
      border-color: var(--accent);
      background: var(--accent);
      color: #fff;
      min-width: 130px;
      height: 40px;
      border-radius: 999px;
      font-size: 14px;
      font-weight: 600;
    }

    .bottom {
      border-top: 1px solid var(--line);
      padding: 10px 14px;
      display: flex;
      gap: 10px;
      align-items: center;
      background: #fbfdff;
    }

    .tip {
      color: var(--muted);
      font-size: 12px;
      line-height: 1.4;
      flex: 1;
    }

    #fileInput { display: none; }

    .drop-zone {
      margin: 0 14px 10px;
      border: 1px dashed #9ab4cc;
      color: #46657f;
      border-radius: 12px;
      padding: 10px;
      text-align: center;
      font-size: 12px;
      background: #f5f9ff;
      display: none;
    }

    .drop-zone.active {
      display: block;
      animation: pulse 1s ease-in-out infinite alternate;
    }

    .toast {
      position: fixed;
      left: 50%;
      bottom: 28px;
      transform: translateX(-50%);
      background: rgba(10, 20, 30, 0.88);
      color: #fff;
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 12px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
      z-index: 99;
    }

    .toast.show { opacity: 1; }

    @keyframes pulse {
      from { box-shadow: 0 0 0 rgba(29, 78, 216, 0.0); }
      to { box-shadow: 0 0 0 4px rgba(29, 78, 216, 0.1); }
    }

  </style>
</head>
<body>
  <div class="app">
    <div class="top">
      <div>
        <div class="title">局域网文件传输</div>
        <div class="meta" id="meta"></div>
      </div>
      <div class="status" id="status">连接中...</div>
    </div>

    <div class="qr-card" id="qrCard">
      <img class="qr-img" id="qrImage" alt="手机扫码二维码" />
      <div class="qr-text">
        <div class="qr-title">手机扫码打开上传页</div>
        <a class="qr-link" id="qrLink" target="_blank" rel="noopener noreferrer"></a>
        <div class="qr-meta">
          <span class="qr-expire" id="qrExpire">有效期剩余 --</span>
          <button class="btn qr-refresh" id="refreshQrBtn" type="button">刷新二维码</button>
        </div>
      </div>
    </div>

    <div class="records" id="records">
      <div class="empty" id="empty">暂无传输记录</div>
    </div>

    <div class="drop-zone" id="dropZone">拖拽文件到此区域，立即发送到手机</div>

    <div class="bottom">
      <div class="tip" id="tip"></div>
      <button class="btn send" id="sendBtn">发送文件</button>
      <input id="fileInput" type="file" multiple />
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    const serverConfig = {
      mobileUrl: {{ mobile_url|tojson }},
      mobileQrDataUrl: {{ mobile_qr_data_url|tojson }},
      tokenExpiresAt: {{ token_expires_at|tojson }},
      sessionId: {{ session_id|tojson }},
      accessDenied: {{ access_denied|tojson }},
      accessDeniedReason: {{ access_denied_reason|tojson }},
    };

    const state = {
      role: detectRole(),
      ws: null,
      hbTimer: null,
      reconnectTimer: null,
      records: [],
      recordIdSet: new Set(),
      sessionId: serverConfig.sessionId || '',
      qrExpiresAt: Number(serverConfig.tokenExpiresAt || 0),
      qrRefreshInFlight: false,
      qrCountdownTimer: null,
    };

    const ui = {
      records: document.getElementById('records'),
      empty: document.getElementById('empty'),
      sendBtn: document.getElementById('sendBtn'),
      fileInput: document.getElementById('fileInput'),
      status: document.getElementById('status'),
      meta: document.getElementById('meta'),
      tip: document.getElementById('tip'),
      dropZone: document.getElementById('dropZone'),
      toast: document.getElementById('toast'),
      qrCard: document.getElementById('qrCard'),
      qrImage: document.getElementById('qrImage'),
      qrLink: document.getElementById('qrLink'),
      qrExpire: document.getElementById('qrExpire'),
      refreshQrBtn: document.getElementById('refreshQrBtn'),
    };

    function detectRole() {
      const role = new URLSearchParams(location.search).get('role');
      if (role === 'desktop' || role === 'mobile') return role;
      return /Mobi|Android|iPhone|iPad/i.test(navigator.userAgent) ? 'mobile' : 'desktop';
    }

    function fmtSize(bytes) {
      if (bytes < 1024) return `${bytes} B`;
      if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;
      if (bytes < 1024 * 1024 * 1024) return `${(bytes / 1024 / 1024).toFixed(1)} MB`;
      return `${(bytes / 1024 / 1024 / 1024).toFixed(2)} GB`;
    }

    function showToast(text) {
      ui.toast.textContent = text;
      ui.toast.classList.add('show');
      setTimeout(() => ui.toast.classList.remove('show'), 1800);
    }

    function setStatus(text, ok = false, err = false) {
      ui.status.textContent = text;
      ui.status.classList.toggle('ok', ok);
      ui.status.classList.toggle('err', err);
    }

    function createRecordNode(record) {
      const row = document.createElement('div');
      row.className = `row ${record.source === 'desktop' ? 'desktop' : 'mobile'}`;

      const bubble = document.createElement('div');
      bubble.className = 'bubble';

      const name = document.createElement('div');
      name.className = 'name';
      name.textContent = record.name;

      const desc = document.createElement('div');
      desc.className = 'desc';
      desc.textContent = `${record.source === 'desktop' ? '电脑' : '手机'} · ${fmtSize(record.size)} · ${record.created_at}`;

      const actions = document.createElement('div');
      actions.className = 'actions';

      const dlBtn = document.createElement('button');
      dlBtn.className = 'btn';
      dlBtn.textContent = '下载';
      dlBtn.addEventListener('click', () => triggerDownload(record));

      actions.appendChild(dlBtn);
      bubble.appendChild(name);
      bubble.appendChild(desc);
      bubble.appendChild(actions);
      row.appendChild(bubble);
      return row;
    }

    function renderRecords() {
      ui.records.innerHTML = '';
      if (state.records.length === 0) {
        ui.records.appendChild(ui.empty);
        ui.empty.style.display = 'block';
        return;
      }

      ui.empty.style.display = 'none';
      for (const record of state.records) {
        ui.records.appendChild(createRecordNode(record));
      }
      ui.records.scrollTop = ui.records.scrollHeight;
    }

    function addRecord(record, notify = true) {
      if (state.recordIdSet.has(record.id)) return;
      state.recordIdSet.add(record.id);
      state.records.push(record);
      renderRecords();

      if (!notify) return;

      if (state.role === 'mobile' && record.source === 'desktop') {
        showToast(`收到文件：${record.name}`);
        notifyInBackground(record);
        setTimeout(() => {
          const ok = window.confirm(`收到电脑文件：${record.name}\n是否立即下载？`);
          if (ok) triggerDownload(record);
        }, 10);
      }
    }

    function triggerDownload(record) {
      const link = document.createElement('a');
      link.href = withSession(record.download_url);
      link.download = record.name;
      document.body.appendChild(link);
      link.click();
      link.remove();
    }

    function withSession(url) {
      if (!state.sessionId) return url;
      const u = new URL(url, location.origin);
      u.searchParams.set('session_id', state.sessionId);
      return u.pathname + u.search;
    }

    function authHeaders() {
      if (!state.sessionId) return {};
      return { 'X-Session-Id': state.sessionId };
    }

    function fmtLeftSeconds(left) {
      if (left <= 0) return '已过期';
      const mm = Math.floor(left / 60);
      const ss = left % 60;
      return `${mm}:${String(ss).padStart(2, '0')}`;
    }

    function tickQrCountdown() {
      if (state.role !== 'desktop') return;
      if (!ui.qrExpire) return;
      const now = Math.floor(Date.now() / 1000);
      const left = Math.max(0, state.qrExpiresAt - now);
      ui.qrExpire.textContent = `有效期剩余 ${fmtLeftSeconds(left)}`;
      if (left === 0 && !state.qrRefreshInFlight) {
        refreshQrPayload();
      }
    }

    function startQrCountdown() {
      if (state.qrCountdownTimer) clearInterval(state.qrCountdownTimer);
      tickQrCountdown();
      state.qrCountdownTimer = setInterval(tickQrCountdown, 1000);
    }

    function applyQrPayload(payload) {
      if (!payload || !payload.mobile_url || !payload.mobile_qr_data_url) return;
      serverConfig.mobileUrl = payload.mobile_url;
      serverConfig.mobileQrDataUrl = payload.mobile_qr_data_url;
      state.qrExpiresAt = Number(payload.token_expires_at || 0);
      ui.qrCard.classList.add('show');
      ui.qrImage.src = serverConfig.mobileQrDataUrl;
      ui.qrLink.href = serverConfig.mobileUrl;
      ui.qrLink.textContent = serverConfig.mobileUrl;
      tickQrCountdown();
    }

    async function refreshQrPayload() {
      if (state.role !== 'desktop' || state.qrRefreshInFlight) return;
      state.qrRefreshInFlight = true;
      if (ui.refreshQrBtn) ui.refreshQrBtn.disabled = true;
      try {
        const resp = await fetch('/auth/mobile-token');
        if (!resp.ok) throw new Error(`refresh failed: ${resp.status}`);
        const payload = await resp.json();
        applyQrPayload(payload);
      } catch (err) {
        console.error(err);
      } finally {
        state.qrRefreshInFlight = false;
        if (ui.refreshQrBtn) ui.refreshQrBtn.disabled = false;
      }
    }

    async function uploadFiles(files, source = state.role) {
      for (const file of files) {
        const form = new FormData();
        form.append('file', file);
        form.append('source', source);

        try {
          const resp = await fetch('/upload', {
            method: 'POST',
            body: form,
            headers: authHeaders(),
          });
          if (!resp.ok) {
            const data = await resp.json().catch(() => ({}));
            throw new Error(data.error || `上传失败(${resp.status})`);
          }
          showToast(`${file.name} 上传成功`);
        } catch (err) {
          showToast(`${file.name} 上传失败`);
          console.error(err);
        }
      }
    }

    function wsUrl() {
      const p = location.protocol === 'https:' ? 'wss' : 'ws';
      const url = new URL(`${p}://${location.host}/ws`);
      if (state.sessionId) url.searchParams.set('session_id', state.sessionId);
      return url.toString();
    }

    function resetHeartbeat() {
      if (state.hbTimer) clearInterval(state.hbTimer);
      const interval = document.hidden ? 7000 : 20000;
      state.hbTimer = setInterval(() => {
        if (state.ws && state.ws.readyState === WebSocket.OPEN) {
          state.ws.send(JSON.stringify({ type: 'ping', ts: Date.now(), hidden: document.hidden }));
        }
      }, interval);
    }

    function connectWS() {
      setStatus('连接中...');
      state.ws = new WebSocket(wsUrl());

      state.ws.onopen = () => {
        setStatus('已连接', true, false);
        resetHeartbeat();
      };

      state.ws.onmessage = (event) => {
        let data;
        try {
          data = JSON.parse(event.data);
        } catch (_) {
          return;
        }

        if (data.type === 'init' && Array.isArray(data.records)) {
          state.records = [];
          state.recordIdSet.clear();
          for (const record of data.records) {
            addRecord(record, false);
          }
          renderRecords();
          return;
        }

        if (data.type === 'new_record' && data.record) {
          addRecord(data.record, true);
        }
      };

      state.ws.onclose = () => {
        setStatus('连接断开，重连中...', false, true);
        if (state.hbTimer) clearInterval(state.hbTimer);
        state.reconnectTimer = setTimeout(connectWS, 1800);
      };

      state.ws.onerror = () => {
        setStatus('连接异常', false, true);
      };
    }

    async function notifyInBackground(record) {
      if (!('Notification' in window)) return;
      if (!document.hidden) return;

      if (Notification.permission === 'default') {
        try { await Notification.requestPermission(); } catch (_) {}
      }
      if (Notification.permission === 'granted') {
        new Notification('收到新文件', { body: record.name });
      }
    }

    async function initHistory() {
      try {
        const resp = await fetch('/records', { headers: authHeaders() });
        if (!resp.ok) return;
        const data = await resp.json();
        if (!Array.isArray(data.records)) return;
        state.records = [];
        state.recordIdSet.clear();
        for (const record of data.records) {
          addRecord(record, false);
        }
        renderRecords();
      } catch (_) {
      }
    }

    function bindEvents() {
      ui.sendBtn.addEventListener('click', () => ui.fileInput.click());
      ui.fileInput.addEventListener('change', (e) => {
        const files = Array.from(e.target.files || []);
        if (files.length) uploadFiles(files, state.role);
        e.target.value = '';
      });

      document.addEventListener('visibilitychange', async () => {
        resetHeartbeat();
        if (document.hidden && 'Notification' in window && Notification.permission === 'default') {
          try { await Notification.requestPermission(); } catch (_) {}
        }
      });

      if (state.role === 'desktop') {
        if (serverConfig.mobileQrDataUrl && serverConfig.mobileUrl) {
          applyQrPayload({
            mobile_url: serverConfig.mobileUrl,
            mobile_qr_data_url: serverConfig.mobileQrDataUrl,
            token_expires_at: serverConfig.tokenExpiresAt,
          });
          startQrCountdown();
        }

        if (ui.refreshQrBtn) {
          ui.refreshQrBtn.addEventListener('click', () => refreshQrPayload());
        }

        ui.dropZone.style.display = 'block';
        ui.tip.textContent = '可点击“发送文件”，也可直接把文件拖到页面上传给手机。';

        const enter = () => ui.dropZone.classList.add('active');
        const leave = () => ui.dropZone.classList.remove('active');

        document.addEventListener('dragenter', (e) => { e.preventDefault(); enter(); });
        document.addEventListener('dragover', (e) => { e.preventDefault(); enter(); });
        document.addEventListener('dragleave', (e) => {
          e.preventDefault();
          if (e.relatedTarget === null) leave();
        });

        document.addEventListener('drop', (e) => {
          e.preventDefault();
          leave();
          const files = Array.from(e.dataTransfer?.files || []);
          if (files.length) uploadFiles(files, 'desktop');
        });
      } else {
        ui.tip.textContent = '点击“发送文件”上传到电脑；收到电脑推送后可一键下载。';
      }
    }

    function init() {
      ui.meta.textContent = `${location.origin} · 当前设备: ${state.role === 'desktop' ? '电脑端' : '手机端'}`;
      if (serverConfig.accessDenied) {
        setStatus('未授权访问', false, true);
        ui.tip.textContent = serverConfig.accessDeniedReason || '当前访问未授权，请重新扫码。';
        ui.sendBtn.disabled = true;
        ui.sendBtn.style.opacity = '0.5';
        return;
      }
      bindEvents();
      initHistory();
      connectWS();
    }

    init();
  </script>
</body>
</html>
